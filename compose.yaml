version: "3.9"

services:
  loki:
    image: grafana/loki:3.0.0
    command:
      - "-config.file=/etc/loki/loki-config.yml"
      - "-config.expand-env=true"
    environment:
      LOKI_RETENTION_PERIOD: "${LOKI_RETENTION_PERIOD:-168h}"
    ports:
      - "${LOKI_HTTP_PORT:-3100}:3100"
    volumes:
      - loki_data:/loki
      - ./services/loki/loki-config.yml:/etc/loki/loki-config.yml:ro
    restart: unless-stopped

  grafana:
    image: grafana/grafana:11.1.0
    depends_on:
      - loki
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: "${GRAFANA_ADMIN_USER:-admin}"
      GF_SECURITY_ADMIN_PASSWORD: "${GRAFANA_ADMIN_PASSWORD:-admin}"
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./services/grafana/provisioning:/etc/grafana/provisioning
    restart: unless-stopped

  syslog:
    build:
      context: ./services/syslog
    image: ha/promtail-syslog:dev
    depends_on:
      - loki
    ports:
      - "${SYSLOG_TCP_PORT:-514}:514/tcp"
      - "${SYSLOG_UDP_PORT:-514}:514/udp"
    environment:
      LOKI_URL: "${LOKI_URL:-http://loki:3100/loki/api/v1/push}"
      LOKI_TENANT_ID: "${LOKI_TENANT_ID:-}"
      SYSLOG_LISTEN_ADDRESS: "${SYSLOG_LISTEN_ADDRESS:-0.0.0.0}"
      SYSLOG_LISTEN_PORT: "${SYSLOG_LISTEN_PORT:-514}"
      SYSLOG_MAX_MESSAGE_LENGTH: "${SYSLOG_MAX_MESSAGE_LENGTH:-0}"
      SYSLOG_FORMAT: "${SYSLOG_FORMAT:-rfc5424}"
    volumes:
      - promtail_positions:/tmp/positions
    command:
      - "-config.file=/etc/promtail/promtail.yaml"
      - "-config.expand-env=true"
    restart: unless-stopped

volumes:
  loki_data:
  grafana_data:
  promtail_positions:
